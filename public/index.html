<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0b0f14" />
<title>Kixonair ‚Äî Live Sports Schedule</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/styles.css?v=9" />
<link rel="icon" href="/logo.svg" type="image/svg+xml" />
</head>
<body>
<header class="header">
  <div class="bar">
    <a class="brand" href="/"><img src="/logo.svg" alt="Kixonair" height="28"/></a>

    <div class="controls">
      <input id="q" type="text" placeholder="Search team‚Ä¶" aria-label="Search team"/>

      <div class="filters" role="tablist">
        <button class="pill active" data-sport="all">All</button>
        <button class="pill" data-sport="Football">Football</button>
        <button class="pill" data-sport="NBA">NBA</button>
        <button class="pill" data-sport="NFL">NFL</button>
      </div>

      <!-- League dropdown (shows only when Football tab is active) -->
      <div class="league-wrap" id="leagueWrap" hidden>
        <button class="pill" id="leagueToggle" aria-expanded="false" aria-controls="leagueMenu">Leagues ‚ñæ</button>
        <div class="league-menu hidden" id="leagueMenu" role="menu" aria-label="Choose league">
          <!-- injected by JS -->
        </div>
        <span class="muted small" id="leagueChosen" style="margin-left:6px;"></span>
      </div>

      <div class="datepick">
        <input id="date" type="date" aria-label="Pick a date"/>
        <button id="today" class="ghost">Today</button>
        <button id="tomorrow" class="ghost">Tomorrow</button>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="hero">
    <h1>Today‚Äôs Games, Zero Noise.</h1>
    <p>Pick a game ‚Üí quick access ‚Üí match center.</p>
  </section>

  <div id="counts" class="counts">Loading‚Ä¶</div>

  <section class="grid" id="grid">
    <div class="section" data-sport="Football">
      <h2>‚öΩ Football</h2>
      <div id="football" class="list"></div>
    </div>
    <div class="section" data-sport="NBA">
      <h2>üèÄ NBA</h2>
      <div id="nba" class="list"></div>
    </div>
    <div class="section" data-sport="NFL">
      <h2>üèà NFL</h2>
      <div id="nfl" class="list"></div>
    </div>
  </section>
</main>

<footer class="footer">
  <div class="inner">
    <span>¬© <span id="yy"></span> Kixonair</span>
    <span class="muted">Fixtures only ‚Äî no streams hosted.</span>
  </div>
</footer>

<script>
  document.getElementById('yy').textContent = new Date().getFullYear();

  // Utilities
  const fmtTime = d => new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  const pills = [...document.querySelectorAll('.pill[data-sport]')];
  const grid = document.getElementById('grid');
  const leagueWrap = document.getElementById('leagueWrap');
  const leagueMenu = document.getElementById('leagueMenu');
  const leagueToggle = document.getElementById('leagueToggle');
  const leagueChosen = document.getElementById('leagueChosen');

  let activeSport = 'all';
  let leagueKey = 'all'; // active league within Football

  // League definitions (robust to different provider names/codes)
  const LEAGUES = [
    { key:'all', label:'All Leagues', test: () => true },
    { key:'ucl', label:'UEFA Champions League', test: fx => codeIs(fx,'CL') || /champions league/i.test(nameOf(fx)) },
    { key:'uel', label:'UEFA Europa League', test: fx => codeIs(fx,'EL') || /europa league/i.test(nameOf(fx)) },
    { key:'uecl', label:'UEFA Europa Conference League', test: fx => codeIs(fx,'ECL') || /conference league/i.test(nameOf(fx)) },

    { key:'pl',  label:'Premier League (England)', test: fx => codeIs(fx,'PL') || /premier league/i.test(nameOf(fx)) },
    { key:'laliga', label:'La Liga (Spain)', test: fx => codeIs(fx,'PD') || /(la\s*liga|primera division)/i.test(nameOf(fx)) },
    { key:'bundes', label:'Bundesliga (Germany)', test: fx => codeIs(fx,'BL1') || /bundesliga/i.test(nameOf(fx)) },
    { key:'seriea', label:'Serie A (Italy)', test: fx => codeIs(fx,'SA') || /serie\s*a/i.test(nameOf(fx)) },
    { key:'ligue1', label:'Ligue 1 (France)', test: fx => codeIs(fx,'FL1') || /ligue\s*1/i.test(nameOf(fx)) },
    { key:'eredivisie', label:'Eredivisie (Netherlands)', test: fx => /eredivisie/i.test(nameOf(fx)) },
    { key:'primeira', label:'Primeira Liga (Portugal)', test: fx => codeIs(fx,'PPL') || /(primeira liga|liga portugal|liga nos)/i.test(nameOf(fx)) },
    { key:'sco', label:'Scottish Premiership', test: fx => /(scottish premiership|premiership \(?scotland\)?)/i.test(nameOf(fx)) },
    { key:'bel', label:'Belgian Pro League', test: fx => /(jupiler|belgian pro league|pro league)/i.test(nameOf(fx)) },
    { key:'tur', label:'S√ºper Lig (Turkey)', test: fx => /(super lig|s√ºper lig)/i.test(nameOf(fx)) }
  ];
  function nameOf(fx){ return (fx.league && (fx.league.name || fx.league.code)) || ''; }
  function codeIs(fx, code){ return fx.league && (fx.league.code||'').toUpperCase() === code.toUpperCase(); }

  // Build league menu
  leagueMenu.innerHTML = LEAGUES.map(L =>
    `<button class="menuitem" role="menuitem" data-league="${L.key}">${L.label}</button>`
  ).join('');

  // Toggle dropdown
  leagueToggle.addEventListener('click', () => {
    const open = leagueToggle.getAttribute('aria-expanded') === 'true';
    leagueToggle.setAttribute('aria-expanded', String(!open));
    leagueMenu.classList.toggle('hidden', open);
  });
  // Close on outside click
  document.addEventListener('click', e => {
    if (!leagueWrap.contains(e.target)) {
      leagueToggle.setAttribute('aria-expanded','false');
      leagueMenu.classList.add('hidden');
    }
  });
  // Choose league
  leagueMenu.addEventListener('click', e => {
    const b = e.target.closest('button[data-league]'); if (!b) return;
    leagueKey = b.dataset.league;
    leagueChosen.textContent = LEAGUES.find(x=>x.key===leagueKey)?.label || '';
    leagueToggle.setAttribute('aria-expanded','false');
    leagueMenu.classList.add('hidden');
    renderLists(); // re-filter Football immediately
  });

  // Sport pills
  pills.forEach(p => p.addEventListener('click', () => {
    pills.forEach(x => x.classList.remove('active'));
    p.classList.add('active');
    activeSport = p.dataset.sport;
    // Show league control only on Football
    leagueWrap.hidden = activeSport !== 'Football';
    renderVisibility();
  }));

  // Date controls
  const dateEl = document.getElementById('date');
  function ymd(ts){ const d = new Date(ts); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
  dateEl.value = ymd(Date.now());
  document.getElementById('today').onclick = ()=>{ dateEl.value = ymd(Date.now()); load(dateEl.value); };
  document.getElementById('tomorrow').onclick = ()=>{ dateEl.value = ymd(Date.now()+86400000); load(dateEl.value); };
  dateEl.addEventListener('change', ()=> load(dateEl.value));

  // Search
  const q = document.getElementById('q');
  q.addEventListener('input', ()=> renderLists());

  // Card builder
  function card(fx){
    const a = document.createElement('a');
    a.className = 'item';
    a.dataset.sport = (fx.sport === 'Soccer') ? 'Football' : fx.sport;
    a.dataset.teams = `${fx.home.name} ${fx.away.name}`.toLowerCase();
    const s = slug(`${fx.home.name}-vs-${fx.away.name}`);
    a.href = `/go/${fx.id}?slug=${encodeURIComponent(s)}`;
    a.innerHTML = `
      <div class="time">${fmtTime(fx.start_utc)}</div>
      <div class="teams"><div class="h">${fx.home.name}</div><div class="vs">vs</div><div class="a">${fx.away.name}</div></div>
      <div class="meta"><span class="league">${fx.league?.name || ''}</span><span class="status">${fx.status || 'SCHEDULED'}</span></div>`;
    return a;
  }

  function skeleton(){ const d = document.createElement('div'); d.className='skeleton'; return d; }
  function setEmpty(el){ el.innerHTML = '<div class="empty">No games for this day.</div>'; }

  let ALL = []; // fixtures cache for the picked date

  function renderVisibility(){
    const sections = Array.from(document.querySelectorAll('.section'));
    let visibleSections = [];
    sections.forEach(sec => {
      const sport = sec.dataset.sport;
      const show = (activeSport==='all' || activeSport===sport);
      sec.style.display = show ? '' : 'none';
      if (show) visibleSections.push(sec);
    });
    grid.classList.toggle('single', visibleSections.length <= 1);
    sections.forEach(sec => sec.querySelector('.list')?.classList.remove('two-col'));
    if (visibleSections.length === 1) {
      const list = visibleSections[0].querySelector('.list');
      if (list) list.classList.add('two-col');
    }
  }

  function renderLists(){
    const term = q.value.trim().toLowerCase();

    // Split fixtures
    const footballAll = ALL.filter(fx => fx.sport === 'Soccer');
    const nba = ALL.filter(fx => fx.sport === 'NBA');
    const nfl = ALL.filter(fx => fx.sport === 'NFL');

    // Apply league filter within Football
    const league = LEAGUES.find(x => x.key === leagueKey) || LEAGUES[0];
    const football = footballAll.filter(fx => league.test(fx));

    // Fill helper
    const fill = (arr, id) => {
      const el = document.getElementById(id);
      el.innerHTML='';
      if (!arr.length) { setEmpty(el); return; }
      let final = arr.slice();
      if (term) {
        final = final.filter(fx => (`${fx.home.name} ${fx.away.name}`.toLowerCase()).includes(term));
      }
      final.sort((a,b)=>new Date(a.start_utc)-new Date(b.start_utc)).forEach(fx => el.appendChild(card(fx)));
      if (!final.length) setEmpty(el);
    };

    fill(football, 'football');
    fill(nba, 'nba');
    fill(nfl, 'nfl');

    // Counts line
    document.getElementById('counts').textContent =
      `Loaded ${football.length} ${leagueKey==='all' ? 'Football' : league.label}, ${nba.length} NBA, ${nfl.length} NFL for ${dateEl.value}`;

    renderVisibility();
  }

  async function load(dateStr){
    ['football','nba','nfl'].forEach(id => {
      const el = document.getElementById(id);
      el.innerHTML = ''; for (let i=0;i<4;i++) el.appendChild(skeleton());
    });
    try{
      const r = await fetch(`/api/fixtures?date=${dateStr}`);
      const j = await r.json();
      ALL = j.fixtures || [];
      renderLists();
    } catch(e){
      document.getElementById('counts').textContent = 'Could not load games. Try again shortly.';
      ['football','nba','nfl'].forEach(id => setEmpty(document.getElementById(id)));
    }
  }

  // Init
  leagueChosen.textContent = 'All Leagues';
  load(dateEl.value);
  // Show league control only on Football
  leagueWrap.hidden = true;
  // When Football tab becomes active, show dropdown control
  pills.find(p=>p.dataset.sport==='Football').addEventListener('click', ()=>{
    leagueWrap.hidden = false;
  });
</script>
</body>
</html>
