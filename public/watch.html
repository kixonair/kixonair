<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kixonair Watch</title>
<link rel="stylesheet" href="/styles.css">
<script>
(function(){
  var ok = ['kixonair.com','www.kixonair.com'];
  try { if (!ok.includes(location.hostname)) location.replace('https://kixonair.com'); } catch(e){}
})();
</script>
</head>
<body>
<main>
  <div id="match"></div>
</main>

<script>
function slug(s){return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}

function matchSlug(slugPart, fx) {
  const clean = s => slug(String(s || '')
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/&/g, "and"));

  const nmHome = clean(fx.home?.name);
  const nmAway = clean(fx.away?.name);
  const pairA = slug(nmHome + '-vs-' + nmAway);
  const pairB = slug(nmAway + '-vs-' + nmHome);
  if (slugPart === pairA || slugPart === pairB) return true;

  const toks = slugPart.split('-vs-');
  if (toks.length === 2) {
    const a = toks[0], b = toks[1];
    return (nmHome.includes(a) && nmAway.includes(b)) ||
           (nmHome.includes(b) && nmAway.includes(a));
  }
  return false;
}

async function init(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if (!id){ document.body.innerHTML='<p>No match selected.</p>'; return; }
  const parts = decodeURIComponent(id).split('@');
  const slugPart = parts[0]; const datePart = (parts[1]||'').substring(0,10);
  try{
    const r = await fetch('/api/fixtures?date='+datePart+'&force=1');
    const j = await r.json();
    const f = (j.fixtures||[]).find(x => matchSlug(slugPart, x));
    if (!f){ document.body.innerHTML='<p>Match not found.</p>'; return; }
    document.getElementById('match').innerHTML = `
      <h1>${f.home.name} vs ${f.away.name}</h1>
      <p><b>League:</b> ${f.league?.name||''}</p>
      <p><b>Status:</b> ${f.status}</p>
      <p><b>Start:</b> ${f.start_utc}</p>
      <p><img src="${f.home.logo||''}" alt=""> vs <img src="${f.away.logo||''}" alt=""></p>
    `;
  }catch(e){
    document.body.innerHTML='<p>Error loading match.</p>';
  }
}
init();
</script>
</body>
</html>
