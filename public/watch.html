<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Kixonair — Match Center</title>
  <link rel="icon" href="/logo.svg" type="image/svg+xml" />
  <style>
    body{margin:0;background:#0f172a;color:#f1f5f9;font-family:'Segoe UI',Tahoma,sans-serif;}
    #kx-loader{position:fixed;inset:0;background:#0f172a;display:flex;align-items:center;justify-content:center;z-index:100;}
    #kx-loader.hidden{display:none;}
    .kx-panel{background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.35);border-radius:16px;padding:20px 26px;text-align:center;min-width:220px;}
    .kx-logo{width:54px;height:54px;background:url('/logo.svg') center/contain no-repeat;margin:0 auto 8px;}
    .kx-title{font-weight:600;}
    .kx-sub{font-size:13px;color:#94a3b8;}

    #page{display:none;}
    .wrap{max-width:980px;margin:0 auto;padding:clamp(12px,3vw,22px);}
    .headerbar{display:grid;grid-template-columns:auto 1fr;align-items:center;margin-bottom:16px;}
    .btn{display:inline-block;padding:8px 14px;border:1px solid #6366f1;border-radius:12px;color:#6366f1;text-decoration:none;font-weight:500;}
    .btn:hover{background:#6366f1;color:#fff;}

    .card{background:rgba(15,23,42,.45);border:1px solid rgba(148,163,184,.15);border-radius:16px;}
    .teams{display:grid;grid-template-columns:1fr auto 1fr;gap:18px;align-items:center;justify-items:center;padding:16px;}
    .side{display:flex;flex-direction:column;align-items:center;gap:10px;}
    .side img{width:80px;height:80px;object-fit:contain;}
    .teamName{font-size:20px;font-weight:600;text-align:center;}
    .h1{font-size:32px;font-weight:800;color:#6366f1;text-align:center;}

    /* centered live time */
    #minuteBig{
      font-size:22px;
      font-weight:700;
      color:#38bdf8;
      text-align:center;
      margin-top:6px;
      display:none;
    }

    .center{text-align:center;color:#94a3b8;margin:10px 0 18px;}
    #statusLine{font-weight:600;color:#e2e8f0;}

    .servercard{margin-top:10px;background:rgba(15,23,42,.45);border:1px solid rgba(148,163,184,.15);border-radius:16px;padding:14px;}
    .serverbar{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;}
    .serverbar a{display:block;background:linear-gradient(135deg,#6366f1,#7c3aed);border-radius:14px;padding:12px 8px;text-align:center;color:#fff;font-weight:500;text-decoration:none;}

    /* popup */
    .tip-overlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:flex;align-items:center;justify-content:center;z-index:200;}
    .tip-overlay.hidden{display:none;}
    .tip-box{background:#ffffff;color:#0f172a;border-radius:16px;padding:18px 18px 14px;max-width:320px;box-shadow:0 12px 40px rgba(0,0,0,.35);}
    .tip-title{font-weight:600;margin-bottom:6px;}
    .tip-text{font-size:13px;line-height:1.4;margin-bottom:14px;}
    .tip-btn{display:inline-block;background:#6366f1;border:none;border-radius:999px;padding:7px 16px;color:#fff;cursor:pointer;font-weight:500;}

    @media(max-width:520px){
      .wrap{padding:10px 10px 80px;}
      .teams .side img{width:58px;height:58px;}
      .teamName{font-size:15px;}
      .tip-box{margin:0 14px;}
    }
  </style>
</head>
<body>
<div id="kx-loader">
  <div class="kx-panel">
    <div class="kx-logo"></div>
    <div class="kx-title">Kixonair</div>
    <div class="kx-sub">Loading match…</div>
  </div>
</div>

<!-- popup with the good text -->
<div id="server-tip" class="tip-overlay hidden">
  <div class="tip-box">
    <div class="tip-title">Streams can be busy</div>
    <div class="tip-text">
      If one server doesn’t load or buffers, tap another one — you can try all 6 servers.
    </div>
    <button class="tip-btn" onclick="document.getElementById('server-tip').classList.add('hidden')">Got it</button>
  </div>
</div>

<div id="page">
  <main class="wrap">
    <div class="headerbar"><a class="btn" href="/">← Back</a></div>

    <div class="card">
      <div class="teams">
        <div class="side">
          <img id="homeLogo" src="/logo.svg" alt="">
          <div id="homeName" class="teamName"></div>
        </div>
        <div>
          <div class="h1">VS</div>
          <div id="minuteBig"></div>
        </div>
        <div class="side">
          <img id="awayLogo" src="/logo.svg" alt="">
          <div id="awayName" class="teamName"></div>
        </div>
      </div>
      <div class="center">
        <div id="statusLine">-</div>
      </div>
    </div>

    <div class="servercard">
      <div id="serverBar" class="serverbar"></div>
    </div>
  </main>
</div>

<script>
  // Utility to get element by id
  function $(id){ return document.getElementById(id); }

  // Query string helper to get parameters
  function qs(name){
    var p = new URLSearchParams(window.location.search);
    return p.get(name) || '';
  }

  // Convert a string into a URL-safe slug
  function slug(str){
    return String(str || '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'');
  }

  // Capitalize each word in a hyphenated or space-separated string
  function capWords(str){
    return String(str || '')
      .split(/[-\s]+/)
      .map(function(w){ return w ? w.charAt(0).toUpperCase() + w.slice(1) : ''; })
      .join(' ');
  }

  // Add days to an ISO date string
  function addDaysISO(iso, n){
    var d = new Date(iso);
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0,10);
  }

  // Convert an ISO date (YYYY-MM-DD) to compact YMD (YYYYMMDD)
  function isoToYMD(iso){ return iso.replace(/-/g,''); }

  // Format fixture status text into human-friendly labels
  function formatStatus(raw){
    raw = String(raw || '').toUpperCase();
    if (/(LIVE|IN_PLAY|PLAYING|Q1|Q2|Q3|Q4|OT|OVERTIME|HALF)/.test(raw)) return 'Live';
    if (/(FINAL|FINISH|ENDED)/.test(raw)) return 'Finished';
    if (/(HALF-TIME|HALFTIME|PAUSED)/.test(raw)) return 'Half / Pause';
    return 'Scheduled';
  }

  // Determine whether to show the minute countdown/timer and format it
  function displayMinute(fx){
    var st = String((fx && fx.status) || '').toUpperCase();
    var live = /(LIVE|IN_PLAY|PLAYING|Q1|Q2|Q3|Q4|OT|OVERTIME|HALF)/.test(st);
    if (!live) return '';
    var m = fx && fx.minute ? String(fx.minute).trim() : '';
    if (!m) return '';
    if (/(AM|PM|ET|GMT|EST)/i.test(m)) return '';
    if (/\d{1,2}\/\d{1,2}/.test(m)) return '';
    return m;
  }

  // Render the server buttons based on a slug (team names)
  function renderServers(slugPart){
    var bar = $('serverBar');
    if (!bar) return;
    var url = '/stream_premium.html?id=' + encodeURIComponent(slugPart) + '&k=2e53b34da32e5044e25f26baddab45';
    var labels = ['Server 1','Server 2','Server 3','Server 4','Server 5','Server 6'];
    var html = '';
    for (var i=0;i<labels.length;i++){
      html += '<a href="'+url+'" target="_blank" rel="noopener">'+labels[i]+'</a>';
    }
    bar.innerHTML = html;
  }

  // Compare slug to fixture data to find a match
  function matchSlug(sl, fx){
    var h = slug(fx && fx.home && fx.home.name);
    var a = slug(fx && fx.away && fx.away.name);
    return sl === (h + '-vs-' + a) || sl === (a + '-vs-' + h);
  }

  /**
   * Fixture caching helpers.
   *
   * The page may poll the remote server frequently (every 25 seconds) to update
   * match status. To reduce network overhead—especially when many users open
   * the same match—we cache responses per date in-memory and in
   * `localStorage`. Cached entries expire after a short TTL (default: 60
   * seconds) to ensure that live matches update regularly.
   */

  // In-memory cache keyed by date (YYYYMMDD)
  var fixturesCache = {};

  // Retrieve cached fixture list from localStorage if it hasn't expired.
  function getFromCache(ymd) {
    // Check in-memory cache first
    if (fixturesCache[ymd] && (Date.now() - fixturesCache[ymd].timestamp < 60000)) {
      return fixturesCache[ymd].data;
    }
    try {
      var stored = localStorage.getItem('fixtures_' + ymd);
      if (stored) {
        var parsed = JSON.parse(stored);
        if (Date.now() - parsed.timestamp < 60000) {
          // Save to in-memory cache for faster subsequent access
          fixturesCache[ymd] = { data: parsed.data, timestamp: parsed.timestamp };
          return parsed.data;
        }
      }
    } catch(e) {
      // ignore JSON parse errors
    }
    return null;
  }

  // Store fixture list in both localStorage and in-memory cache
  function saveToCache(ymd, data) {
    var entry = { timestamp: Date.now(), data: data };
    fixturesCache[ymd] = entry;
    try {
      localStorage.setItem('fixtures_' + ymd, JSON.stringify(entry));
    } catch(e) {
      // localStorage may be unavailable (e.g., privacy mode), ignore errors
    }
  }

  /**
   * Fetch fixtures for a given ISO date. Uses caching to avoid excessive
   * requests to the remote API. If a cached response is available and fresh,
   * it is returned immediately. Otherwise, the data is fetched from the
   * server, cached, and returned.
   *
   * @param {string} isoDate - Date in YYYY-MM-DD format
   * @returns {Promise<Array>} List of fixtures for that date
   */
  async function fixturesFor(isoDate){
    var ymd = isoToYMD(isoDate);
    var cached = getFromCache(ymd);
    if (cached) {
      return cached;
    }
    var url = 'https://fotbal.site/fixtures.php?date=' + ymd;
    try{
      var r = await fetch(url, {cache:'no-store'});
      if (!r.ok) return [];
      var j = await r.json();
      var data = j && j.fixtures ? j.fixtures : [];
      saveToCache(ymd, data);
      return data;
    }catch(e){
      // On network errors, fallback to stale cache if available
      return cached || [];
    }
  }

  // Update the displayed fixture status (e.g., Live / Finished / Scheduled)
  function applyFixtureStatus(fx){
    var statusText = formatStatus(fx && fx.status);
    $('statusLine').textContent = statusText || '-';

    var minute = displayMinute(fx);
    if (minute){
      $('minuteBig').textContent = minute;
      $('minuteBig').style.display = 'block';
    } else {
      $('minuteBig').style.display = 'none';
    }
  }

  // Populate team names, logos, status, and server links based on fixture data
  function applyFixture(fx){
    var hn = fx && fx.home && fx.home.name ? fx.home.name : 'Home';
    var an = fx && fx.away && fx.away.name ? fx.away.name : 'Away';
    $('homeName').textContent = hn;
    $('awayName').textContent = an;
    $('homeLogo').src = (fx && fx.home && fx.home.logo) ? fx.home.logo : '/logo.svg';
    $('awayLogo').src = (fx && fx.away && fx.away.logo) ? fx.away.logo : '/logo.svg';
    applyFixtureStatus(fx);
    renderServers(slug(hn + '-vs-' + an));
  }

  /**
   * Start polling fixture status updates. This uses the cached fixtures list
   * but periodically refreshes the status to reflect the latest minute and
   * final outcome. The polling stops once a finished status is detected.
   *
   * @param {string} baseISO - Base date in ISO format
   * @param {string} slugPart - Slug of home vs away
   */
  function startStatusPoll(baseISO, slugPart){
    async function tick(){
      var list = await fixturesFor(baseISO);
      var hit = null;
      for (var i=0;i<list.length;i++){
        if (matchSlug(slugPart, list[i])){
          hit = list[i];
          break;
        }
      }
      if (hit){
        applyFixtureStatus(hit);
        var st = String(hit.status || '').toUpperCase();
        if (/(FINAL|FINISH|ENDED)/.test(st)) return;
      }
      setTimeout(tick, 25000);
    }
    tick();
  }

  /**
   * Main entry point. Parses query parameters, attempts to preload fixture
   * information from the past and next few days, and displays the match.
   * Also starts the polling logic for live updates.
   */
  async function load(){
    var raw = qs('id') || qs('m') || '';
    var pure = raw.indexOf('@') !== -1 ? raw.split('@')[0] : raw;

    if (pure){
      var parts = pure.split('-vs-');
      if (parts.length === 2){
        $('homeName').textContent = capWords(parts[0]);
        $('awayName').textContent = capWords(parts[1]);
        renderServers(pure);
      } else {
        $('homeName').textContent = capWords(pure);
        renderServers(pure);
      }
    }

    var baseISO = raw.indexOf('@') !== -1
      ? raw.split('@')[1].replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')
      : new Date().toISOString().slice(0,10);

    var slugPart = slug(pure);

    // Try to find the fixture within +/- 2 days for better matching
    var days = [-2,-1,0,1,2];
    var found = null;
    var foundDate = baseISO;

    for (var d=0; d<days.length; d++){
      var iso = addDaysISO(baseISO, days[d]);
      var list = await fixturesFor(iso);
      for (var i=0;i<list.length;i++){
        if (matchSlug(slugPart, list[i])){
          found = list[i];
          foundDate = iso;
          break;
        }
      }
      if (found) break;
    }

    if (found){
      applyFixture(found);
      startStatusPoll(foundDate, slugPart);
    }

    $('kx-loader').classList.add('hidden');
    $('page').style.display = 'block';
    $('server-tip').classList.remove('hidden');
  }

  // Kick off the page load when the script is evaluated
  load();
</script>
</body>
</html>
