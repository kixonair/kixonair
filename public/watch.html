<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Kixonair — Match Center</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#0f172a;color:#fff;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.25);text-decoration:none;color:#fff;background:rgba(15,23,42,.5)}
    .teams{margin-top:18px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.12);border-radius:16px;padding:18px;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;justify-items:center}
    .side{display:flex;flex-direction:column;align-items:center;gap:8px}
    .side img{width:72px;height:72px;object-fit:contain}
    .teamName{font-size:20px;font-weight:600}
    .vs{font-size:32px;font-weight:800;color:#6366f1}
    .meta{margin-top:14px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.12);border-radius:16px;padding:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .lbl{font-size:11px;text-transform:uppercase;color:rgba(241,245,249,.5);margin-bottom:3px}
    .serverbar{margin-top:14px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.12);border-radius:16px;padding:14px;display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    .serverbar a{background:linear-gradient(135deg,#6366f1,#7c3aed);color:#fff;text-decoration:none;padding:10px 18px;border-radius:999px;font-weight:500}
    #loadingOverlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;z-index:50}
    #loadingOverlay.hidden{display:none}
    .spinner{width:42px;height:42px;border:4px solid rgba(255,255,255,.15);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #debug{margin-top:16px;background:rgba(15,23,42,.5);border:1px solid rgba(248,113,113,.4);border-radius:12px;padding:12px;font-size:12px;white-space:pre-wrap;word-break:break-word}
    @media(max-width:650px){.teams{grid-template-columns:1fr}.meta{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>Loading match...</div>
</div>
<main class="wrap">
  <a href="/" class="badge">← Back</a>

  <div class="teams">
    <div class="side">
      <img id="homeLogo" src="/logo.svg" alt="">
      <div id="homeName" class="teamName">Home</div>
    </div>
    <div class="vs">VS</div>
    <div class="side">
      <img id="awayLogo" src="/logo.svg" alt="">
      <div id="awayName" class="teamName">Away</div>
    </div>
  </div>

  <p id="statusLine" style="text-align:center;margin-top:8px;color:#94a3b8;">Loading…</p>

  <div class="meta">
    <div><div class="lbl">Kickoff</div><div id="kickoff">-</div></div>
    <div><div class="lbl">Competition</div><div id="league">-</div></div>
    <div><div class="lbl">Status</div><div id="state">-</div></div>
  </div>

  <div id="serverBar" class="serverbar"></div>

  <div id="debug">debug output…</div>
</main>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const debug = msg => { $("#debug").textContent += "\\n" + msg; };

  function hideLoading(){ $("#loadingOverlay").classList.add("hidden"); }
  function qs(n){ return new URLSearchParams(location.search).get(n) || ""; }
  function getMatchId(){ return qs("id") || qs("m") || ""; }
  function slug(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""); }
  function capWords(s){ return String(s||"").split(/[-\\s]+/).map(w=>w?w[0].toUpperCase()+w.slice(1):"").join(" "); }
  function isoToYyyymmdd(iso){ return iso.replace(/-/g,""); }
  function addDaysISO(iso, n){ const d = new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
  function formatStatus(st){
    const r = String(st||"").toUpperCase();
    if (r.includes("IN_PROGRESS") || r.includes("LIVE")) return "Live";
    if (r.includes("FINAL")) return "Finished";
    if (r.includes("SCHEDULED")) return "Scheduled";
    return st || "";
  }

  // prefill names from URL
  (function prime(){
    const id = getMatchId();
    if (!id) return;
    const pure = id.includes("@") ? id.split("@")[0] : id;
    const parts = pure.split("-vs-");
    if (parts.length === 2){
      $("#homeName").textContent = capWords(parts[0]);
      $("#awayName").textContent = capWords(parts[1]);
    } else {
      $("#homeName").textContent = capWords(pure);
    }
    // servers
    const url = "https://crutchanalyse.com/w2n5uxyv5?key=421e53b34da32e5044e25f26baddab45";
    const labels = ["Server 1","Server 2","Server 3","Server 4","Server 5"];
    $("#serverBar").innerHTML = labels.map(l=>`<a href="${url}" target="_blank" rel="noopener">${l}</a>`).join("");
  })();

  // fetch fixtures for one date, from 2 possible places
  async function fetchFixturesFor(isoDate){
    const ymd = isoToYyyymmdd(isoDate);
    const urls = [
      `/fixtures.php?date=${ymd}`,                     // local
      `https://fotbal.site/fixtures.php?date=${ymd}`   // remote fallback
    ];
    const allErrors = [];
    for (const u of urls){
      try{
        const r = await fetch(u, {cache:"no-store"});
        const text = await r.text();
        debug(`GET ${u} -> ${r.status}`);
        debug(`body: ${text.slice(0,180)}`);
        let data;
        try { data = JSON.parse(text); }
        catch(e){ allErrors.push(`JSON error for ${u}: ${e}`); continue; }
        if (Array.isArray(data)) return {list:data, errors:allErrors};
        if (data && Array.isArray(data.fixtures)) return {list:data.fixtures, errors:allErrors};
        allErrors.push(`no array in ${u}`);
      }catch(e){
        allErrors.push(`fetch error for ${u}: ${e}`);
      }
    }
    return {list:[], errors:allErrors};
  }

  function matchBySlug(sl, fx){
    const h = slug(fx.home && fx.home.name || "");
    const a = slug(fx.away && fx.away.name || "");
    return sl === `${h}-vs-${a}` || sl === `${a}-vs-${h}`;
  }

  function applyFixture(fx){
    $("#homeName").textContent = fx.home?.name || $("#homeName").textContent;
    $("#awayName").textContent = fx.away?.name || $("#awayName").textContent;
    if (fx.home?.logo) $("#homeLogo").src = fx.home.logo;
    if (fx.away?.logo) $("#awayLogo").src = fx.away.logo;
    $("#league").textContent = fx.league?.name || "-";
    $("#kickoff").textContent = fx.start_utc || "-";
    const st = formatStatus(fx.status);
    $("#state").textContent = st || "-";
    $("#statusLine").textContent = st || "";
  }

  (async function load(){
    debug("starting load()");
    const id = getMatchId();
    if (!id){ $("#statusLine").textContent = "Missing match id"; hideLoading(); return; }

    const hasAt = id.includes("@");
    const slugPart = slug(hasAt ? id.split("@")[0] : id);
    const baseISO = hasAt
      ? id.split("@")[1].replace(/(\\d{4})(\\d{2})(\\d{2})/,"$1-$2-$3")
      : new Date().toISOString().slice(0,10);

    debug(`slugPart=${slugPart}`);
    debug(`baseISO=${baseISO}`);

    const days = [-2,-1,0,1,2];
    let found = null;
    let collectedErrors = [];

    for (const off of days){
      const dISO = addDaysISO(baseISO, off);
      debug(`trying date ${dISO}`);
      const {list, errors} = await fetchFixturesFor(dISO);
      collectedErrors = collectedErrors.concat(errors);
      if (!list.length) continue;
      const hit = list.find(fx => matchBySlug(slugPart, fx));
      if (hit){ found = hit; break; }
    }

    if (found){
      debug("MATCHED fixture, applying UI");
      applyFixture(found);
    } else {
      debug("NO MATCH. Errors below:");
      collectedErrors.forEach(e => debug(e));
      $("#statusLine").textContent = "";
    }

    hideLoading();
  })();
})();
</script>
</body>
</html>
