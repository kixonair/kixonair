<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Kixonair — Match Center</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css?v=22" />
  <link rel="icon" href="/logo.svg" type="image/svg+xml" />
  
<style>
  :root{ --pad: clamp(12px, 3vw, 22px); }
  .wrap{max-width:980px;margin:0 auto;padding:var(--pad)}
  .headerbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;margin-bottom:10px}
  .headerbar .center{justify-self:center;}
  .badge{display:inline-block;border:1px solid #2a2f37;border-radius:999px;padding:4px 10px;font-size:12px;max-width:50vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* Teams row with grid areas for perfect centering */
  .teams{display:grid;grid-template-columns:1fr auto 1fr;grid-template-areas:'home vs away';gap:14px;align-items:center;justify-items:center;margin:12px 0 6px}
  .home{grid-area:home}
  .away{grid-area:away}
  .versus{grid-area:vs}
  .side{display:flex;align-items:center;gap:10px;justify-content:center;text-align:center}
  .side.right{flex-direction:row-reverse}
  .side img{width:clamp(44px,8vw,72px);height:clamp(44px,8vw,72px);object-fit:contain}
  .teamName{font-size:clamp(16px,4vw,20px);font-weight:600}
  .h1{font-size:clamp(22px,6vw,32px);font-weight:800;text-align:center}
  .muted{opacity:.75}
  /* Meta grid collapses gracefully */
  .meta{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:14px 0}
  @media(max-width:720px){ .meta{grid-template-columns:repeat(2,minmax(0,1fr));} }
  /* Player */
  .player{width:100%;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;margin:14px 0;display:flex;align-items:center;justify-content:center}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #2a2f37;border-radius:12px;padding:10px 14px;text-decoration:none;color:#cbd5e1}
  .btn:hover{background:#121821}
  /* Skeletons */
  .sk{position:relative;background:#0e131a;border-radius:8px;overflow:hidden}
  .sk::after{content:'';position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.06), rgba(255,255,255,0));animation:sh 1.1s infinite}
  @keyframes sh{to{transform:translateX(100%)}}
  .nameSk{height:20px;width:60%;margin:6px auto;border-radius:6px}
  /* Mobile: stack teams vertically; hide long badge */
  @media(max-width:600px){
    .teams{grid-template-columns:1fr;grid-template-areas:'home' 'vs' 'away';gap:8px}
    #leagueBadge{display:none}
  }

  /* Loading overlay */
  .loading{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(3,8,14,.75);backdrop-filter:saturate(120%) blur(2px);z-index:50;transition:opacity .25s ease}
  .loading.hidden{opacity:0;pointer-events:none}
  .spinner{position:relative;width:72px;height:72px;margin-bottom:12px}
  .ring{position:absolute;inset:0;border-radius:50%;border:4px solid rgba(255,255,255,.12);border-top-color:rgba(255,255,255,.6);animation:spin 1s linear infinite}
  .dot{position:absolute;top:50%;left:50%;width:14px;height:14px;background:#22c55e;border-radius:50%;transform:translate(-50%,-50%);animation:pulse 1.2s ease-in-out infinite}
  .loadingText{font-size:14px;opacity:.85}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(.85);opacity:.8}50%{transform:translate(-50%,-50%) scale(1.1);opacity:1}}
</style>


</head>
<body>
<header class="header">
  <div class="bar">
    <a class="brand" href="/"><img src="/logo.svg" alt="Kixonair" height="28"/></a>
    <div style="flex:1"></div>
  </div>
</header>

<main class="wrap">
  <div id="loadingOverlay" class="loading hidden" aria-live="polite" aria-busy="true">
    <div class="spinner">
      <div class="ring"></div>
      <div class="dot"></div>
    </div>
    <div class="loadingText">Loading match data…</div>
  </div>

  <div class="headerbar">
    <a class="btn" href="/" aria-label="Back to schedule">← Back</a><div class="center"></div>
    <span id="leagueBadge" class="badge"></span>
  </div>

  <div class="teams">
    <div class="side left"><img id="homeLogo" alt="" /><span id="homeName"></span></div>
    <div class="h1 versus" id="versus">VS</div>
    <div class="side right"><img id="awayLogo" alt="" /><span id="awayName"></span></div>
  </div>
  <div class="muted" id="statusLine" style="text-align:center"></div>

  <div class="meta">
    <div><span class="muted small">Kickoff</span><div id="kickoff">-</div></div>
    <div><span class="muted small">Competition</span><div id="league">-</div></div>
    <div><span class="muted small">Status</span><div id="state">-</div></div>
  </div>

  <section class="player" id="player">
    <div class="muted">No stream connected. Add one later — this page is dedicated to the match data.</div>
  </section>

  <div id="extLinkWrap" style="display:none;text-align:center">
    <a id="extLink" class="btn" target="_blank" rel="noopener">Open external stream ↗</a>
  </div>
</main>

<script>
  let __loadFailTimer = null;
  function hideLoading(){
    try{ document.getElementById('loadingOverlay').classList.add('hidden'); }catch{}
    if(__loadFailTimer){ clearTimeout(__loadFailTimer); __loadFailTimer=null; }
  }

  function qs(name){ return new URLSearchParams(location.search).get(name) || ''; }
  function set(el, val){ el.textContent = val || ''; }

  async function load(){ document.getElementById('loadingOverlay').classList.remove('hidden'); __loadFailTimer = setTimeout(hideLoading, 5000);
    const id = qs('id');
    const maybeSrc = qs('src'); // if someone manually adds it, we only show a button, no embedding.

    if (maybeSrc){
      const a = document.getElementById('extLink');
      a.href = maybeSrc;
      document.getElementById('extLinkWrap').style.display = 'block';
    }

    if (!id){
      document.getElementById('statusLine').textContent = 'Missing match id';
      return;
    }

    try{
      const r = await fetch('/api/fixture/' + encodeURIComponent(id));
      const j = await r.json();
      const fx = j.fixture || j || {};

      const homeName = fx.home?.name || 'Home';
      const awayName = fx.away?.name || 'Away';
      const homeLogo = fx.home?.logo || '';
      const awayLogo = fx.away?.logo || '';
      const league   = fx.league?.name || '';
      const status   = fx.status || 'SCHEDULED';
      const kickoff  = fx.start_utc || '';

      set(document.getElementById('homeName'), homeName);
      set(document.getElementById('awayName'), awayName);
      document.getElementById('homeLogo').src = homeLogo || '/logo.svg';
      document.getElementById('awayLogo').src = awayLogo || '/logo.svg';
      set(document.getElementById('leagueBadge'), league);
      set(document.getElementById('league'), league);
      set(document.getElementById('state'), status);
      set(document.getElementById('kickoff'), kickoff ? new Date(kickoff).toLocaleString() : '-');
      set(document.getElementById('statusLine'), status);
    }catch(e){
      set(document.getElementById('statusLine'), 'Could not load match data.');
    }
  }
  load();
</script>

<script>
  function qs(name){ return new URLSearchParams(location.search).get(name) || ''; }
  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function capWords(s){ return String(s||'').split(/[-\s]+/).map(w => w? w[0].toUpperCase()+w.slice(1):'').join(' '); }
  function timeMs(x){ try{ return Date.parse(String(x)); }catch{return NaN;} }

  async function hydrateFromFixture(fx){
    const homeName = fx.home?.name || 'Home';
    const awayName = fx.away?.name || 'Away';
    const homeLogo = fx.home?.logo || '';
    const awayLogo = fx.away?.logo || '';
    const league   = fx.league?.name || '';
    const status   = fx.status || 'SCHEDULED';
    const kickoff  = fx.start_utc || '';

    document.getElementById('homeName').textContent = homeName;
    document.getElementById('awayName').textContent = awayName;
    document.getElementById('homeLogo').src = homeLogo || '/logo.svg';
    document.getElementById('awayLogo').src = awayLogo || '/logo.svg';
    document.getElementById('leagueBadge').textContent = league || '';
    document.getElementById('league').textContent = league || '-';
    document.getElementById('state').textContent = status || '-';
    document.getElementById('kickoff').textContent = kickoff ? new Date(kickoff).toLocaleString() : '-';
    document.getElementById('statusLine').textContent = status || '';
  }

  async function clientSearch(slugPart, isoHint){
    function teamTokens(name){
      const s = slug(name);
      const parts = s.split('-').filter(Boolean);
      const first = parts[0] || s, last = parts[parts.length-1] || s;
      return { full:s, first, last };
    }
    function matchSlug(fx){
      const nmHome = teamTokens(fx.home?.name || '');
      const nmAway = teamTokens(fx.away?.name || '');
      const pairA = slug(nmHome.full + '-vs-' + nmAway.full);
      const pairB = slug(nmAway.full + '-vs-' + nmHome.full);
      if (slugPart === pairA || slugPart === pairB) return true;
      const toks = slugPart.split('-vs-');
      if (toks.length === 2){
        const a=toks[0], b=toks[1];
        const hitAB = (nmHome.full.includes(a) || nmHome.first===a || nmHome.last===a) && (nmAway.full.includes(b) || nmAway.first===b || nmAway.last===b);
        const hitBA = (nmHome.full.includes(b) || nmHome.first===b || nmHome.last===b) && (nmAway.full.includes(a) || nmAway.first===a || nmAway.last===a);
        return hitAB || hitBA;
      }
      return false;
    }
    async function fixturesFor(dateStr){
      const r = await fetch('/api/fixtures?date=' + encodeURIComponent(dateStr)).catch(()=>null);
      const j = r ? await r.json().catch(()=>null) : null;
      return Array.isArray(j?.fixtures) ? j.fixtures : [];
    }
    function ymdFromIso(x){
      if (!x) return null;
      try{ return String(x).slice(0,10); }catch{return null;}
    }
    const today = new Date().toISOString().slice(0,10);
    function addDays(dateStr, delta){
      const dt = new Date(Date.UTC(+dateStr.slice(0,4), +dateStr.slice(5,7)-1, +dateStr.slice(8,10)));
      dt.setUTCDate(dt.getUTCDate()+delta);
      return dt.toISOString().slice(0,10);
    }
    const base = ymdFromIso(isoHint) || today;
    const days = [addDays(base,-1), base, addDays(base,1), addDays(base,2)];
    let cands = [];
    for (const d of days){
      const list = await fixturesFor(d);
      cands.push(...list.filter(matchSlug));
    }
    if (!cands.length) return null;
    const tHint = timeMs(isoHint);
    if (!Number.isNaN(tHint)){
      cands.sort((a,b)=> Math.abs(timeMs(a.start_utc)-tHint) - Math.abs(timeMs(b.start_utc)-tHint));
    }
    return cands[0];
  }

  async function load(){ document.getElementById('loadingOverlay').classList.remove('hidden'); __loadFailTimer = setTimeout(hideLoading, 5000);
    const id = qs('id');
    const maybeSrc = qs('src');
    if (maybeSrc){
      const a = document.getElementById('extLink');
      a.href = maybeSrc;
      document.getElementById('extLinkWrap').style.display = 'block';
    }

    // Pre-fill names from slug so the page looks contextual even before data loads
    if (id && id.includes('@')){
      const slugPart = id.split('@')[0];
      const toks = slugPart.split('-vs-');
      if (toks.length === 2){
        document.getElementById('homeName').textContent = capWords(toks[0]);
        document.getElementById('awayName').textContent = capWords(toks[1]);
      }
    }

    if (!id){ document.getElementById('statusLine').textContent='Missing match id'; return; }

    // Primary: server resolver
    let fx = null;
    try{
      const r = await fetch('/api/fixture/' + encodeURIComponent(id));
      if (r.ok){
        const j = await r.json();
        fx = j && (j.fixture || j.fixture === null ? j.fixture : null);
      }
    }catch(e){ /* ignore */ }

    if (fx){ await hydrateFromFixture(fx); return; }

    // Fallback: client-side search across /api/fixtures
    try{
      const hasAt = id.includes('@');
      const slugPart = slug(hasAt ? id.split('@')[0] : id);
      const isoHint  = hasAt ? id.split('@')[1] : null;
      const hit = await clientSearch(slugPart, isoHint);
      if (hit){ await hydrateFromFixture(hit); return; }
    }catch(e){ /* ignore */ }

    document.getElementById('statusLine').textContent = 'Could not load match data.';
  }
  load();
</script>
</body>

</html>
